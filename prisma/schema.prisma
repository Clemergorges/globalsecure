
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  REVIEW // Added
}

enum AccountStatus {
  UNVERIFIED // Added
  PENDING    // Added
  ACTIVE
  FROZEN
  CLOSED
  SUSPENDED
}

enum AddressStatus {
  UNVERIFIED
  VERIFIED
  REJECTED
}

enum DocumentType {
  PASSPORT
  NATIONAL_ID
  RESIDENCE_PERMIT
  DRIVERS_LICENSE
}

enum WalletTxType {
  CREDIT
  DEBIT
  WITHDRAW
  REFUND
  FEE
  DEPOSIT
}

enum TransferType {
  CARD
  ACCOUNT
}

enum TransferStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELED
  FAILED
  REFUNDED
}

enum CardStatus {
  ACTIVE
  INACTIVE
  CANCELED
  EXPIRED
}

enum UnlockStatus {
  LOCKED
  UNLOCKED
}

enum CryptoStatus {
  PENDING
  CONFIRMED
  CREDITED
  FAILED
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum WithdrawStatus {
  PENDING
  BROADCASTED
  CONFIRMED
  FAILED
  CANCELLED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified Boolean   @default(false)
  passwordHash  String
  
  // Basic Identity
  firstName     String?
  lastName      String?
  phone         String?   @unique
  phoneVerified Boolean   @default(false)
  
  // Extended KYC Data (European Standard)
  dateOfBirth   DateTime? // Replaces birthDate
  countryOfBirth String?
  nationality   String?
  
  // Identity Document
  documentType   DocumentType?
  documentNumber String?   @unique // Replaces documentId
  documentExpiry DateTime?
  
  // Old fields to be migrated/deprecated
  birthDate     DateTime? // Deprecated in favor of dateOfBirth
  documentId    String?   // Deprecated in favor of documentNumber
  
  kycLevel      Int       @default(0)
  kycStatus     KYCStatus @default(PENDING)
  
  // Consent
  gdprConsent   Boolean   @default(false)
  gdprConsentAt DateTime?
  cookieConsent Boolean   @default(false)
  marketingConsent Boolean @default(false)
  
  // Localization
  country       String?
  language      String?   @default("en")
  timezone      String    @default("Europe/Luxembourg")
  
  // Flattened Address (Deprecated in favor of Address model, but kept for backward compatibility if needed)
  address       String?
  city          String?
  postalCode    String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  account       Account?
  addresses     Address[]
  transfersSent Transfer[] @relation("Sender")
  transfersReceived Transfer[] @relation("Recipient")
  kycDocuments  KYCDocument[]
  sessions      Session[]
  otps          OTP[]
  notifications Notification[]
  cryptoDeposits CryptoDeposit[]
  topUps        TopUp[]
  cryptoWithdraws CryptoWithdraw[]
  swaps         Swap[]
  virtualCards  VirtualCard[]
  auditLogs     AuditLog[]
  userTransactions UserTransaction[]
  kycVerifications KycVerification[]
  savingsGoals     SavingsGoal[]
  spendingLimits   SpendingLimit[]
  recurringPayments RecurringPayment[]
  
  @@index([email])
  @@index([phone])
  @@index([country])
  createdClaimLinks ClaimLink[]
}

model Address {
  id          String        @id @default(uuid())
  userId      String
  streetLine1 String
  streetLine2 String?
  postalCode  String
  city        String
  region      String?
  country     String
  status      AddressStatus @default(UNVERIFIED)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  user        User          @relation(fields: [userId], references: [id])
  
  @@index([userId])
}

model Account {
  id                 String        @id @default(uuid())
  userId             String        @unique
  status             AccountStatus @default(PENDING) // Changed default
  primaryCurrency    String        @default("EUR")
  cryptoAddress      String?       @unique
  cryptoAddressIndex Int?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  user         User                @relation(fields: [userId], references: [id])
  balances     Balance[]
  transactions AccountTransaction[]
  userTransactions UserTransaction[]
  savingsGoals     SavingsGoal[]

  @@index([userId])
  @@index([status])
}

model Balance {
  id        String   @id @default(uuid())
  accountId String
  currency  String
  amount    Decimal  @default(0) @db.Decimal(12, 2)
  updatedAt DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id])

  @@unique([accountId, currency])
  @@index([accountId])
}

model AccountTransaction {
  id          String       @id @default(uuid())
  accountId   String
  type        WalletTxType
  amount      Decimal      @db.Decimal(12, 2)
  currency    String       @default("EUR")
  description String
  transferId  String?
  createdAt   DateTime     @default(now())

  account  Account   @relation(fields: [accountId], references: [id])
  transfer Transfer? @relation(fields: [transferId], references: [id])

  @@index([accountId])
  @@index([transferId])
  @@index([createdAt])
}

model Transfer {
  id               String         @id @default(uuid())
  senderId         String
  recipientEmail   String
  recipientName    String?
  recipientId      String?
  amountSent       Decimal        @db.Decimal(12, 2)
  currencySent     String
  fee              Decimal        @db.Decimal(12, 2)
  feePercentage    Decimal        @default(1.8) @db.Decimal(5, 2)
  exchangeRate     Decimal        @default(1) @db.Decimal(10, 6)
  amountReceived   Decimal        @db.Decimal(12, 2)
  currencyReceived String
  type             TransferType
  status           TransferStatus @default(PENDING)
  amlCheckPassed   Boolean        @default(false)
  amlCheckAt       DateTime?
  createdAt        DateTime       @default(now())
  completedAt      DateTime?
  canceledAt       DateTime?

  sender    User      @relation("Sender", fields: [senderId], references: [id])
  recipient User?     @relation("Recipient", fields: [recipientId], references: [id])
  card      VirtualCard?
  logs      TransactionLog[]
  accountTransactions AccountTransaction[]

  @@index([senderId])
  @@index([recipientId])
  @@index([recipientEmail])
  @@index([status])
  @@index([createdAt])
}

model VirtualCard {
  id                 String     @id @default(uuid())
  transferId         String?    @unique
  userId             String?
  stripeCardId       String     @unique
  stripeCardholderId String
  last4              String
  brand              String     @default("visa")
  expMonth           Int
  expYear            Int
  amount             Decimal    @db.Decimal(12, 2)
  currency           String
  amountUsed         Decimal    @default(0) @db.Decimal(12, 2)
  status             CardStatus @default(ACTIVE)
  unlockCode         String?
  unlockedAt         DateTime?
  activationToken    String?    @unique
  activatedAt        DateTime?
  createdAt          DateTime   @default(now())
  expiresAt          DateTime
  lastUsedAt         DateTime?
  canceledAt         DateTime?

  transfer          Transfer?             @relation(fields: [transferId], references: [id])
  user              User?                 @relation(fields: [userId], references: [id])
  spendTransactions SpendTransaction[]
  activationTokens  CardActivationToken[]
  spendingLimits    SpendingLimit[]
  claimLink         ClaimLink?

  @@index([stripeCardId])
  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([last4])
}

model SpendTransaction {
  id               String   @id @default(uuid())
  cardId           String
  stripeAuthId     String   @unique
  stripeTxId       String?  @unique
  amount           Decimal  @db.Decimal(12, 2)
  currency         String
  merchantName     String?
  merchantCategory String?
  merchantCity     String?
  merchantCountry  String?
  status           String
  createdAt        DateTime @default(now())

  card VirtualCard @relation(fields: [cardId], references: [id])

  @@index([cardId])
  @@index([createdAt])
}

model CardActivationToken {
  id        String   @id @default(uuid())
  token     String   @unique
  cardId    String
  expiresAt DateTime
  used      Boolean  @default(false)
  usedAt    DateTime?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  card VirtualCard @relation(fields: [cardId], references: [id])

  @@index([token])
  @@index([cardId])
}

model KYCDocument {
  id                   String    @id @default(uuid())
  userId               String
  documentType         String?
  documentNumber       String
  issuingCountry       String
  frontImageUrl        String?
  backImageUrl         String?
  selfieUrl            String?
  stripeVerificationId String?   @unique
  status               KYCStatus @default(PENDING)
  rejectionReason      String?
  verifiedAt           DateTime?
  createdAt            DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  ipAddress String?
  userAgent String?
  country   String?
  lastScaAt DateTime?
  createdAt DateTime @default(now())
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
}

model OTP {
  id        String   @id @default(uuid())
  userId    String
  type      String   @default("EMAIL")
  channel   String?
  target    String?
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([target, code])
  @@index([userId])
}

model TransactionLog {
  id         String   @id @default(uuid())
  transferId String
  type       String
  metadata   Json?
  actorId    String?
  ipAddress  String?
  createdAt  DateTime @default(now())

  transfer Transfer @relation(fields: [transferId], references: [id])

  @@index([transferId])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  body      String
  read      Boolean  @default(false)
  type      String   @default("INFO")
  actionUrl String?
  actionText String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([read])
}

model FxRateHistory {
  id           String   @id @default(uuid())
  fromCurrency String
  toCurrency   String
  rate         Decimal  @db.Decimal(10, 6)
  source       String   @default("MANUAL") // API_NAME or MANUAL
  createdAt    DateTime @default(now())
  
  @@index([fromCurrency, toCurrency, createdAt])
}

model CryptoDeposit {
  id          String       @id @default(uuid())
  userId      String
  txHash      String       @unique
  network     String       @default("POLYGON")
  token       String       @default("USDT")
  amount      Decimal      @db.Decimal(18, 6)
  status      CryptoStatus @default(PENDING)
  walletTxId  String?      @unique
  detectedAt  DateTime     @default(now())
  confirmedAt DateTime?
  creditedAt  DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([txHash])
  @@index([status])
}

model TopUp {
  id              String   @id @default(uuid())
  userId          String
  amount          Decimal  @db.Decimal(12, 2)
  currency        String
  stripeSessionId String   @unique
  status          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([stripeSessionId])
}

model Job {
  id          String    @id @default(uuid())
  type        String
  payload     Json
  status      JobStatus @default(PENDING)
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  lastError   String?
  runAt       DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([runAt])
}

model CryptoWithdraw {
  id           String         @id @default(uuid())
  userId       String
  asset        String
  amount       Decimal        @db.Decimal(18, 6)
  toAddress    String
  txHash       String?
  status       WithdrawStatus @default(PENDING)
  errorMessage String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model Swap {
  id          String   @id @default(uuid())
  userId      String
  fromAsset   String
  toAsset     String
  fromAmount  Decimal  @db.Decimal(18, 6)
  toAmount    Decimal  @db.Decimal(18, 6)
  rateBase    Decimal  @db.Decimal(18, 6)
  spread      Decimal  @db.Decimal(18, 6)
  rateApplied Decimal  @db.Decimal(18, 6)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

model ClaimLink {
  id          String    @id @default(uuid())
  token       String    @unique
  creatorId   String
  amount      Decimal   @db.Decimal(20, 8)
  currency    String
  message     String?
  status      ClaimStatus @default(PENDING)
  expiresAt   DateTime
  claimedAt   DateTime?
  claimedByIP String?
  
  virtualCardId String? @unique
  virtualCard   VirtualCard? @relation(fields: [virtualCardId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  creator     User      @relation(fields: [creatorId], references: [id])
  
  @@index([token])
  @@index([creatorId])
  @@index([status])
}

enum ClaimStatus {
  PENDING
  CLAIMED
  EXPIRED
  CANCELLED
}

enum AuditAction {
  LOGIN
  LOGOUT
  TRANSFER_CREATED
  CARD_ISSUED
  PASSWORD_CHANGED
  KYC_SUBMITTED
  SUSPICIOUS_ACTIVITY
  REGISTER_SUCCESS
  REGISTER_FAILED
  REGISTER_BLOCKED
  REGISTER_ERROR
  API_ERROR
}

enum KycLevel {
  BASIC
  ADVANCED
  PREMIUM
}

enum LimitType {
  OVERALL
  CATEGORY
  MERCHANT
}

enum LimitPeriod {
  DAILY
  WEEKLY
  MONTHLY
}

enum TransactionType {
  PIX_IN
  SEPA_IN
  CARD_OUT
  TRANSFER
  FX
  CRYPTO_IN
  CRYPTO_OUT
  FEE
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

// --- NEW AUDIT LOG MODEL ---
model AuditLog {
  id        String      @id @default(uuid())
  userId    String?
  action    String      // Changed to String to support flexible actions or map to Enum manually if needed
  status    String      // e.g. "SUCCESS", "FAILURE", "429"
  ipAddress String?
  userAgent String?
  method    String?     // GET, POST
  path      String?     // /api/auth/login
  metadata  Json?       // Any extra details
  duration  Int?        // ms
  createdAt DateTime    @default(now())

  user      User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@index([status])
}

enum TransactionCategory {
  GROCERIES
  RESTAURANTS
  TRANSPORT
  ENTERTAINMENT
  SHOPPING
  BILLS
  TRANSFERS
  OTHER
}

enum PaymentFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
}

enum RecurringStatus {
  ACTIVE
  PAUSED
  CANCELLED
  COMPLETED
}

model UserTransaction {
  id          String            @id @default(uuid())
  userId      String
  accountId   String
  type        TransactionType
  amount      Decimal           @db.Decimal(12, 2)
  currency    String
  status      TransactionStatus @default(PENDING)
  category    TransactionCategory?
  metadata    Json?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  user        User              @relation(fields: [userId], references: [id])
  account     Account           @relation(fields: [accountId], references: [id])

  @@index([userId, createdAt])
  @@index([type, status])
  @@index([accountId, createdAt])
  @@index([currency, createdAt])
}

model RecurringPayment {
  id           String           @id @default(uuid())
  userId       String
  recipientId  String           // User ID or External IBAN
  amount       Decimal          @db.Decimal(12, 2)
  currency     String
  frequency    PaymentFrequency
  nextRunDate  DateTime
  status       RecurringStatus  @default(ACTIVE)
  createdAt    DateTime         @default(now())
  
  user         User             @relation(fields: [userId], references: [id])
  
  @@index([userId, nextRunDate])
  @@index([status, nextRunDate])
}

model KycVerification {
  id              String    @id @default(uuid())
  userId          String    @unique
  level           KycLevel  @default(BASIC)
  status          KYCStatus
  documentType    String?
  verificationId  String?
  rejectionReason String?
  submittedAt     DateTime?
  approvedAt      DateTime?
  
  // New Fields for advanced tracking
  riskScore       Int?      @default(0)
  reviewedBy      String?   // Admin ID
  reviewedAt      DateTime?
  
  user            User      @relation(fields: [userId], references: [id])
}

model SavingsGoal {
  id            String    @id @default(uuid())
  userId        String
  accountId     String
  name          String
  targetAmount  Decimal   @db.Decimal(12, 2)
  currentAmount Decimal   @default(0) @db.Decimal(12, 2)
  deadline      DateTime?
  emoji         String?
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id])
  account       Account   @relation(fields: [accountId], references: [id])

  @@index([userId, createdAt])
}

model SpendingLimit {
  id        String      @id @default(uuid())
  userId    String
  cardId    String?
  type      LimitType
  period    LimitPeriod
  amount    Decimal     @db.Decimal(12, 2)
  spent     Decimal     @default(0) @db.Decimal(12, 2)
  resetAt   DateTime
  
  user      User        @relation(fields: [userId], references: [id])
  card      VirtualCard? @relation(fields: [cardId], references: [id])
}
